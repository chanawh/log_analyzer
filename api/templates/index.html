<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Log Analyzer Web Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
    <h1 class="mb-4 text-primary">Log Analyzer Demo</h1>
    <form id="uploadForm" enctype="multipart/form-data" class="card p-4 shadow-sm mb-4">
        <div class="mb-3">
            <label for="logfile" class="form-label">Upload Log File</label>
            <input type="file" id="logfile" name="logfile" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>
    <div id="clearFileDiv" style="display:none;">
        <form id="clearFileForm" style="display:inline;">
            <button type="submit" class="btn btn-danger">Clear Uploaded File</button>
        </form>
    </div>
    <form id="filterForm" class="card p-4 shadow-sm mb-4" style="display:none;">
        <div class="mb-3">
            <label for="keyword" class="form-label">Keyword (regex supported)</label>
            <input type="text" id="keyword" name="keyword" class="form-control">
        </div>
        <div class="row mb-3">
            <div class="col">
                <label for="start_date" class="form-label">Start Date (YYYY-MM-DD)</label>
                <input type="text" id="start_date" name="start_date" class="form-control">
            </div>
            <div class="col">
                <label for="end_date" class="form-label">End Date (YYYY-MM-DD)</label>
                <input type="text" id="end_date" name="end_date" class="form-control">
            </div>
        </div>
        <div class="mb-3">
            <label for="categories" class="form-label">Custom Categories (one per line, format: <code>CategoryName:regex</code>)</label>
            <textarea id="categories" name="categories" class="form-control" rows="4" placeholder="Example&#10;Errors:error|fail&#10;Starts:Started|Begin"></textarea>
            <small class="text-muted">Example: <code>Errors:error|fail</code> <code>Starts:Started|Begin</code></small>
        </div>
        <div class="mb-3" id="categoryDropdownDiv" style="display:none;">
            <label for="selected_category" class="form-label">Matching Lines Category</label>
            <select name="selected_category" id="selected_category" class="form-control"></select>
        </div>
        <button type="submit" class="btn btn-info">Analyze</button>
    </form>
    <div id="resultArea"></div>

    <!-- SSH/Remote Log Tail Section (restored) -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-dark">SSH Connect & Remote Log Tail</div>
        <div class="card-body">
            <form id="sshForm" class="mb-3">
                <input type="text" id="ssh_host" placeholder="Host" class="form-control mb-2">
                <input type="text" id="ssh_user" placeholder="Username" class="form-control mb-2">
                <input type="password" id="ssh_pass" placeholder="Password" class="form-control mb-2">
                <button type="submit" class="btn btn-warning">Connect</button>
            </form>
            <div id="sshStatus"></div>
            <div id="remoteBrowser" style="display:none;">
                <div class="mb-2">
                    <span>Current Directory: <span id="sshCurrentPath"></span></span>
                    <button id="sshGoUp" class="btn btn-sm btn-secondary ms-2">Up</button>
                </div>
                <ul id="sshFileList" class="list-group mb-2"></ul>
                <input type="text" id="sshManualDir" placeholder="Enter directory path" class="form-control mb-2">
                <button id="sshChangeDir" class="btn btn-sm btn-info mb-2">Go</button>
                <input type="text" id="sshTailFile" placeholder="Filename to tail" class="form-control mb-2">
                <button id="sshTailStart" class="btn btn-sm btn-success mb-2">Tail File</button>
                <button id="sshDisconnect" class="btn btn-sm btn-danger mb-2">Disconnect</button>
                <div id="liveLogArea"></div>
            </div>
        </div>
    </div>
</div>
<script>
let charts = {};
function destroyCharts() {
    for (const k in charts) {
        if (charts[k]) charts[k].destroy();
    }
    charts = {};
}

function showAlert(msg, type="danger") {
    document.getElementById("resultArea").innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
}

function renderResults(data) {
    destroyCharts();
    let html = "";
    if (data.error) {
        showAlert(data.error);
        return;
    }
    if (data.summary) {
        html += `<div class="card mb-3">
            <div class="card-header bg-info text-white">Summary</div>
            <div class="card-body"><pre>${data.summary}</pre>
                <h5 class="mt-4">Entries per Category/Program</h5>
                <canvas id="programChart" height="120"></canvas>
                <h5 class="mt-4">Category Distribution</h5>
                <canvas id="levelChart" height="120"></canvas>
                <h5 class="mt-4">Log Activity Over Time</h5>
                <canvas id="timeChart" height="120"></canvas>
            </div>
        </div>`;
    }
    if (data.grouped && Object.keys(data.grouped).length) {
        html += `<div class="card mb-3">
            <div class="card-header bg-secondary text-white">
                Grouped by ${data.categories_input ? "Custom Category" : "Program"}
            </div>
            <div class="card-body">
                <table class="table table-bordered table-sm">
                    <thead><tr>
                        <th>${data.categories_input ? "Category" : "Program"}</th>
                        <th>Entries (showing up to 5)</th>
                    </tr></thead>
                    <tbody>`;
        for (const key in data.grouped) {
            html += `<tr><td>${key}</td><td><ul>`;
            let entries = data.grouped[key];
            for (let i=0; i<entries.length; ++i) {
                html += `<li>${entries[i]}</li>`;
            }
            html += `</ul></td></tr>`;
        }
        html += `</tbody></table></div></div>`;
    }
    if (data.lines && data.lines.length) {
        html += `<div class="card mb-3">
            <div class="card-header bg-success text-white">Matching Lines (up to 100)</div>
            <div class="card-body">
                <pre style="max-height: 300px; overflow-y: auto;">${data.lines.join("\n")}</pre>
                <form action="/explain" method="post" class="mt-3">
                    <label for="log_text">Explain a log line:</label>
                    <select name="log_text" id="log_text" style="width:100%;">`;
        for (let i=0; i<Math.min(10, data.lines.length); ++i) {
            html += `<option value="${data.lines[i]}">${data.lines[i]}</option>`;
        }
        html += `</select>
                    <button type="submit" class="btn btn-info mt-2">Explain Selected Line</button>
                </form>
            </div>
        </div>`;
    }
    document.getElementById("resultArea").innerHTML = html;

    // Render charts
    let chart_data = data.chart_data || {};
    // Bar chart
    let programLabels = Object.keys(chart_data.program_counts || {});
    let programValues = Object.values(chart_data.program_counts || {});
    let programCanvas = document.getElementById('programChart');
    if (programLabels.length && programCanvas) {
        charts.program = new Chart(programCanvas.getContext('2d'), {
            type: 'bar',
            data: { labels: programLabels, datasets: [{ label: 'Entries', data: programValues, backgroundColor: '#007bff' }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }
    // Pie chart
    let levelLabels = Object.keys(chart_data.level_counts || {});
    let levelValues = Object.values(chart_data.level_counts || {});
    let levelCanvas = document.getElementById('levelChart');
    if (levelLabels.length && levelCanvas) {
        charts.level = new Chart(levelCanvas.getContext('2d'), {
            type: 'pie',
            data: {
                labels: levelLabels,
                datasets: [{ data: levelValues, backgroundColor: [
                    '#007bff','#28a745','#dc3545','#ffc107','#17a2b8','#6f42c1','#fd7e14','#20c997','#e83e8c','#6610f2'
                ] }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    }
    // Multi-series line chart by category/keyword
    let timeSeries = chart_data.time_series || {};
    let timeCanvas = document.getElementById('timeChart');
    if (Object.keys(timeSeries).length && timeCanvas) {
        // Collect all dates from all series
        let allDates = new Set();
        Object.values(timeSeries).forEach(dateMap => {
            Object.keys(dateMap).forEach(d => allDates.add(d));
        });
        let dateLabels = Array.from(allDates).sort();
        // Assign colors for up to 11 series (last for Total)
        let colorList = [
            '#007bff','#28a745','#dc3545','#ffc107','#17a2b8','#6f42c1','#fd7e14','#20c997','#e83e8c','#6610f2','#343a40'
        ];
        let datasets = Object.entries(timeSeries).map(([cat, dateMap], idx) => {
            let isTotal = (cat === "Total");
            return {
                label: cat,
                data: dateLabels.map(d => dateMap[d] || 0),
                borderColor: colorList[idx % colorList.length],
                fill: false,
                tension: 0.3,
                borderWidth: isTotal ? 4 : 2,
                pointRadius: isTotal ? 3 : 2,
                pointBackgroundColor: isTotal ? colorList[idx % colorList.length] : undefined,
                borderDash: isTotal ? [8,4] : [],
            }
        });
        charts.time = new Chart(timeCanvas.getContext('2d'), {
            type: 'line',
            data: { labels: dateLabels, datasets: datasets },
            options: {
                responsive: true,
                plugins: { legend: { display: true, position: 'top' } }
            }
        });
    } else {
        // fallback for single-series chart
        let timestamps = chart_data.timestamps || [];
        let dateCounts = {};
        timestamps.forEach(d => { dateCounts[d] = (dateCounts[d] || 0) + 1; });
        let dateLabels = Object.keys(dateCounts).sort();
        let dateValues = dateLabels.map(d => dateCounts[d]);
        if (dateLabels.length && timeCanvas) {
            charts.time = new Chart(timeCanvas.getContext('2d'), {
                type: 'line',
                data: { labels: dateLabels, datasets: [{ label: 'Entries', data: dateValues, borderColor: '#007bff', fill: false, tension: 0.3 }] },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }
    }
}

// --- File upload ---
document.getElementById("uploadForm").onsubmit = function(e) {
    e.preventDefault();
    let fileInput = document.getElementById("logfile");
    if (!fileInput.files.length) return;
    let formData = new FormData();
    formData.append("logfile", fileInput.files[0]);
    fetch("/upload", { method: "POST", body: formData })
        .then(r => r.json()).then(data => {
            if (data.success) {
                document.getElementById("uploadForm").style.display = "none";
                document.getElementById("filterForm").style.display = "";
                document.getElementById("clearFileDiv").style.display = "";
                runAnalysis();
            } else {
                showAlert(data.error || "Upload failed.");
            }
        }).catch(_ => showAlert("Upload failed."));
};

// --- Clear file ---
document.getElementById("clearFileForm").onsubmit = function(e) {
    e.preventDefault();
    fetch("/clear_file", { method: "POST" })
        .then(r => r.json()).then(data => {
            if (data.success) {
                document.getElementById("uploadForm").style.display = "";
                document.getElementById("filterForm").style.display = "none";
                document.getElementById("clearFileDiv").style.display = "none";
                document.getElementById("resultArea").innerHTML = "";
                destroyCharts();
            } else {
                showAlert("Couldn't clear file.");
            }
        });
};

function runAnalysis() {
    let payload = {
        keyword: document.getElementById("keyword").value,
        start_date: document.getElementById("start_date").value,
        end_date: document.getElementById("end_date").value,
        categories: document.getElementById("categories").value,
        selected_category: document.getElementById("selected_category") ? document.getElementById("selected_category").value : ""
    };
    fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        renderResults(data);
        // update dropdown if needed
        let ddDiv = document.getElementById("categoryDropdownDiv");
        if (data.category_names && data.category_names.length) {
            ddDiv.style.display = "";
            let sel = document.getElementById("selected_category");
            sel.innerHTML = "";
            for (const cat of data.category_names) {
                let opt = document.createElement("option");
                opt.value = cat;
                opt.textContent = cat;
                if (cat === data.selected_category) opt.selected = true;
                sel.appendChild(opt);
            }
        } else {
            ddDiv.style.display = "none";
        }
    });
}

// --- Filters ---
document.getElementById("filterForm").onsubmit = function(e) {
    e.preventDefault();
    runAnalysis();
};
["keyword", "start_date", "end_date", "categories"].forEach(id => {
    document.getElementById(id).addEventListener("input", () => {
        runAnalysis();
    });
});
document.getElementById("selected_category").addEventListener("change", runAnalysis);

// --- SSH Section JS ---
document.getElementById('sshForm').onsubmit = function(e) {
    e.preventDefault();
    let host = document.getElementById('ssh_host').value;
    let user = document.getElementById('ssh_user').value;
    let pass = document.getElementById('ssh_pass').value;
    fetch('/ssh/connect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ host, username: user, password: pass })
    }).then(r => r.json()).then(data => {
        if (data.error) {
            document.getElementById('sshStatus').innerText = data.error;
            document.getElementById('remoteBrowser').style.display = 'none';
        } else {
            document.getElementById('sshStatus').innerText = data.message;
            document.getElementById('remoteBrowser').style.display = '';
            document.getElementById('sshCurrentPath').innerText = data.current_path;
            updateSSHFileList();
        }
    });
};

function updateSSHFileList() {
    fetch('/ssh/list').then(r => r.json()).then(data => {
        let ul = document.getElementById('sshFileList');
        ul.innerHTML = '';
        if (data.items) {
            data.items.forEach(item => {
                let li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = item.is_dir ? '[DIR] ' + item.name : item.name;
                li.onclick = function() {
                    if (item.is_dir) {
                        fetch('/ssh/change', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ subdir: item.name })
                        }).then(r => r.json()).then(data => {
                            document.getElementById('sshCurrentPath').innerText = data.current_path;
                            updateSSHFileList();
                        });
                    }
                };
                ul.appendChild(li);
            });
        }
    });
}

document.getElementById('sshGoUp').onclick = function() {
    fetch('/ssh/change', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subdir: '..' })
    }).then(r => r.json()).then(data => {
        document.getElementById('sshCurrentPath').innerText = data.current_path;
        updateSSHFileList();
    });
};

document.getElementById('sshChangeDir').onclick = function() {
    let dir = document.getElementById('sshManualDir').value;
    fetch('/ssh/change', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subdir: dir })
    }).then(r => r.json()).then(data => {
        document.getElementById('sshCurrentPath').innerText = data.current_path;
        updateSSHFileList();
    });
};

document.getElementById('sshTailStart').onclick = function() {
    let filename = document.getElementById('sshTailFile').value;
    if (!filename) return;
    let logArea = document.getElementById('liveLogArea');
    logArea.innerText = '';
    let evtSource = new EventSource(`/ssh/tail?filename=${encodeURIComponent(filename)}`);
    evtSource.onmessage = function(e) {
        logArea.innerText += e.data + "\n";
        logArea.scrollTop = logArea.scrollHeight;
    };
    evtSource.onerror = function() {
        evtSource.close();
    };
};

document.getElementById('sshDisconnect').onclick = function() {
    fetch('/ssh/disconnect', { method: 'POST' })
        .then(r => r.json()).then(data => {
            document.getElementById('sshStatus').innerText = data.message;
            document.getElementById('remoteBrowser').style.display = 'none';
        });
};
</script>
</body>
</html>
